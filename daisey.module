<?php

ini_set('display_errors',1);
ini_set('display_startup_errors',1);
error_reporting(-1);

function daisey_init() 
{
	// User is logged in and the page does not excist
	if(user_is_logged_in() && !menu_get_item($_GET['q'])) 
	{
		$allowedFileTypes = array("htm", "html", "css", "js", "png", "jpg", "gif", "png", "xml", "jpeg", "pdf");
		$uriWQ =  explode("?", $_SERVER["REQUEST_URI"]);

		$filePath = drupal_get_path('module', 'daisey') . '/files' . $uriWQ[0];

		if (file_exists($filePath))
		{
			$tex = explode(".", $filePath);
			$tex = $tex[count($tex) - 1];

			if (array_search($tex, $allowedFileTypes) !== false)
			{
				$finfo = finfo_open(FILEINFO_MIME_TYPE);
				$mime = finfo_file($finfo, $filePath);
				finfo_close($finfo);

				$size = filesize($filePath);

				// New mimetype standard fix
				if (strtolower($tex) == "css")
				{
					$mime = "text/css";
				}
				else if (strtolower($tex) == "js")
				{
					$mime = "application/javascript";
				}

				$headers = array(
					header('Content-Type:' . $mime),
					header('Content-Length:' . $size),
					header('Cache-Control: max-age=604800, public'),
					);

				if (ob_get_level()) 
				{
					ob_end_clean();
				}

				foreach ($headers as $name => $value) 
				{
					drupal_add_http_header($name, $value);
				}

				drupal_send_headers();
				
				if ($fd = fopen($filePath, 'rb')) 
				{
					while (!feof($fd)) 
					{
						print fread($fd, 1024);
					}

					fclose($fd);
				}
				else 
				{
					drupal_not_found();
				}

				drupal_exit();
			}
		}
	}
}